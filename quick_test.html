<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <title>üß™ Quick Test - Support Ticket</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 p-8">
    <div class="max-w-4xl mx-auto">
        <h1 class="text-3xl font-bold mb-6">üß™ Support Ticket - Quick Test</h1>
        
        <!-- Test 1: Database Connection -->
        <div class="bg-white rounded-lg p-6 mb-4 shadow">
            <h2 class="text-xl font-bold mb-4">Test 1: Database Connection</h2>
            <button onclick="testDatabase()" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">
                Test Database
            </button>
            <div id="dbResult" class="mt-4"></div>
        </div>
        
        <!-- Test 2: Submit Support Ticket -->
        <div class="bg-white rounded-lg p-6 mb-4 shadow">
            <h2 class="text-xl font-bold mb-4">Test 2: Submit Support Ticket</h2>
            <button onclick="testSubmit()" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700">
                Test Submit
            </button>
            <div id="submitResult" class="mt-4"></div>
        </div>
        
        <!-- Test 3: View Latest Tickets -->
        <div class="bg-white rounded-lg p-6 mb-4 shadow">
            <h2 class="text-xl font-bold mb-4">Test 3: Latest Tickets</h2>
            <button onclick="testView()" class="bg-purple-600 text-white px-4 py-2 rounded hover:bg-purple-700">
                View Latest
            </button>
            <div id="viewResult" class="mt-4"></div>
        </div>
        
        <!-- Console -->
        <div class="bg-black text-green-400 rounded-lg p-4 font-mono text-sm">
            <div class="font-bold mb-2">Console:</div>
            <div id="console"></div>
        </div>
    </div>

    <script>
        const consoleDiv = document.getElementById('console');
        
        function log(msg) {
            const time = new Date().toLocaleTimeString();
            consoleDiv.innerHTML += `[${time}] ${msg}<br>`;
            console.log(msg);
        }
        
        async function testDatabase() {
            log('Testing database connection...');
            const div = document.getElementById('dbResult');
            div.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Testing...';
            
            try {
                const response = await fetch('api/test_db.php');
                const data = await response.json();
                
                if (data.success) {
                    div.innerHTML = `
                        <div class="bg-green-50 border border-green-200 rounded p-4">
                            <div class="flex items-center gap-2 text-green-600 font-bold mb-2">
                                <i class="fas fa-check-circle"></i>
                                Database Connected!
                            </div>
                            <div class="text-sm text-gray-600">
                                Total tickets: ${data.count}<br>
                                Message: ${data.message}
                            </div>
                        </div>
                    `;
                    log('‚úÖ Database OK: ' + data.count + ' tickets');
                } else {
                    div.innerHTML = `
                        <div class="bg-red-50 border border-red-200 rounded p-4">
                            <div class="text-red-600 font-bold">${data.message}</div>
                        </div>
                    `;
                    log('‚ùå Database Error: ' + data.message);
                }
            } catch (error) {
                div.innerHTML = `<div class="text-red-600">Error: ${error.message}</div>`;
                log('‚ùå Exception: ' + error.message);
            }
        }
        
        async function testSubmit() {
            log('Testing submit support ticket...');
            const div = document.getElementById('submitResult');
            div.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Submitting...';
            
            try {
                const formData = new FormData();
                formData.append('nama', 'Test User');
                formData.append('email', 'test@example.com');
                formData.append('kategori', 'Lainnya');
                formData.append('subjek', 'Test Ticket');
                formData.append('pesan', 'Ini adalah test ticket untuk verifikasi sistem.');
                
                const response = await fetch('api/submit_support.php', {
                    method: 'POST',
                    body: formData
                });
                
                const contentType = response.headers.get("content-type");
                log('Response Content-Type: ' + contentType);
                
                if (!contentType || !contentType.includes("application/json")) {
                    const text = await response.text();
                    log('‚ö†Ô∏è Response is not JSON');
                    log('Raw response: ' + text);
                    div.innerHTML = `
                        <div class="bg-yellow-50 border border-yellow-200 rounded p-4">
                            <div class="text-yellow-800 font-bold mb-2">Response is not JSON!</div>
                            <pre class="text-xs overflow-x-auto">${text}</pre>
                        </div>
                    `;
                    return;
                }
                
                const data = await response.json();
                log('Response: ' + JSON.stringify(data));
                
                if (data.success) {
                    div.innerHTML = `
                        <div class="bg-green-50 border border-green-200 rounded p-4">
                            <div class="flex items-center gap-2 text-green-600 font-bold mb-2">
                                <i class="fas fa-check-circle"></i>
                                Ticket Submitted!
                            </div>
                            <div class="text-sm text-gray-600">
                                Ticket ID: ${data.ticket_id}<br>
                                Message: ${data.message}
                            </div>
                        </div>
                    `;
                    log('‚úÖ Ticket created: ID #' + data.ticket_id);
                } else {
                    div.innerHTML = `
                        <div class="bg-red-50 border border-red-200 rounded p-4">
                            <div class="text-red-600 font-bold">${data.message}</div>
                        </div>
                    `;
                    log('‚ùå Submit failed: ' + data.message);
                }
            } catch (error) {
                div.innerHTML = `<div class="text-red-600">Error: ${error.message}</div>`;
                log('‚ùå Exception: ' + error.message);
            }
        }
        
        async function testView() {
            log('Loading latest tickets...');
            const div = document.getElementById('viewResult');
            div.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Loading...';
            
            try {
                const response = await fetch('api/test_db.php?action=list');
                const data = await response.json();
                
                if (data.success && data.tickets) {
                    if (data.tickets.length === 0) {
                        div.innerHTML = '<div class="text-gray-500">No tickets yet</div>';
                        log('‚ÑπÔ∏è No tickets found');
                    } else {
                        let html = '<div class="space-y-2">';
                        data.tickets.forEach(ticket => {
                            html += `
                                <div class="bg-gray-50 rounded p-3 border">
                                    <div class="font-bold">Ticket #${ticket.id}</div>
                                    <div class="text-sm text-gray-600">
                                        ${ticket.nama_user} (${ticket.email})<br>
                                        ${ticket.kategori} - ${ticket.subjek}<br>
                                        Status: <span class="font-bold text-${ticket.status === 'open' ? 'yellow' : 'green'}-600">${ticket.status}</span>
                                    </div>
                                </div>
                            `;
                        });
                        html += '</div>';
                        div.innerHTML = html;
                        log('‚úÖ Loaded ' + data.tickets.length + ' tickets');
                    }
                } else {
                    div.innerHTML = '<div class="text-red-600">Failed to load tickets</div>';
                    log('‚ùå Failed to load tickets');
                }
            } catch (error) {
                div.innerHTML = `<div class="text-red-600">Error: ${error.message}</div>`;
                log('‚ùå Exception: ' + error.message);
            }
        }
    </script>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</body>
</html>